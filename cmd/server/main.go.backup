package main

import (
	"context"
	"fmt"
	"net/http"
	"strconv"

	"GoCodeMentor/internal/pkg/siliconflow"
	"GoCodeMentor/internal/repository"
	"GoCodeMentor/internal/service"

	"github.com/gin-gonic/gin"
	"github.com/skip2/go-qrcode"
)

func main() {
	if err := repository.InitDB(); err != nil {
		panic("数据库初始化失败：" + err.Error())
	}

	client := siliconflow.NewClient()
	sessionSvc := service.NewSessionService(client)
	assignSvc := service.NewAssignmentService(client)
	feedbackSvc := service.NewFeedbackService()

	r := gin.Default()

	// 加载模板（解析 templates 文件夹下所有 html）
	r.LoadHTMLGlob("web/templates/*")

	// 静态文件服务（CSS/JS）
	r.Static("/static", "./web/static")

	// ========== 页面路由（模板渲染） ==========

	// 首页 - 聊天
	r.GET("/", func(c *gin.Context) {
		c.HTML(http.StatusOK, "chat.html", gin.H{
			"Title": "课堂答疑",
			"Nav":   "chat",
		})
	})

	// 作业管理页面
	r.GET("/assignments", func(c *gin.Context) {
		c.HTML(http.StatusOK, "assignment.html", gin.H{
			"Title": "作业管理",
			"Nav":   "assignment",
		})
	})

	// 反馈论坛页面
	r.GET("/feedback", func(c *gin.Context) {
		c.HTML(http.StatusOK, "feedback.html", gin.H{
			"Title": "意见反馈",
			"Nav":   "feedback",
		})
	})

	// ========== API 接口（保持和之前一样） ==========

	// 聊天 API
	r.POST("/api/chat", func(c *gin.Context) {
		var req struct {
			SessionID string `json:"session_id"`
			Question  string `json:"question"`
		}
		if err := c.BindJSON(&req); err != nil {
			c.JSON(400, gin.H{"error": "参数错误"})
			return
		}

		ctx := context.Background()
		answer, sessionID, err := sessionSvc.Chat(ctx, req.SessionID, req.Question)
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}

		c.JSON(200, gin.H{
			"answer":     answer,
			"session_id": sessionID,
		})
	})

	r.GET("/api/history", func(c *gin.Context) {
		sessionID := c.Query("session_id")
		if sessionID == "" {
			c.JSON(200, []interface{}{})
			return
		}
		messages, err := sessionSvc.GetHistory(sessionID)
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, messages)
	})

	// 获取所有会话列表
	r.GET("/api/sessions", func(c *gin.Context) {
		sessions, err := sessionSvc.GetAllSessions()
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, sessions)
	})

	// 作业 API
	r.POST("/api/assignments/generate", func(c *gin.Context) {
		var req struct {
			Topic      string `json:"topic"`
			Difficulty string `json:"difficulty"`
			TeacherID  string `json:"teacher_id"`
		}
		if err := c.BindJSON(&req); err != nil {
			c.JSON(400, gin.H{"error": "参数错误"})
			return
		}

		ctx := context.Background()
		assign, err := assignSvc.GenerateAssignmentByAI(ctx, req.Topic, req.Difficulty, req.TeacherID)
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}

		c.JSON(200, gin.H{
			"assignment_id": assign.ID,
			"title":         assign.Title,
			"message":       "AI生成作业成功",
		})
	})

	r.POST("/api/assignments", func(c *gin.Context) {
		var req struct {
			Title       string `json:"title"`
			Description string `json:"description"`
			Rubric      string `json:"rubric"`
			Type        string `json:"type"`
			TeacherID   string `json:"teacher_id"`
		}
		if err := c.BindJSON(&req); err != nil {
			c.JSON(400, gin.H{"error": "参数错误"})
			return
		}

		id, err := assignSvc.CreateAssignment(req.Title, req.Description, req.Rubric, req.TeacherID, req.Type)
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}

		c.JSON(200, gin.H{"assignment_id": id, "message": "创建成功"})
	})

	r.GET("/api/assignments", func(c *gin.Context) {
		assignments, err := assignSvc.GetAssignmentList()
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, assignments)
	})

	r.GET("/api/assignments/:id", func(c *gin.Context) {
		id := c.Param("id")
		assign, questions, err := assignSvc.GetAssignmentDetail(id)
		if err != nil {
			c.JSON(404, gin.H{"error": "作业不存在"})
			return
		}
		c.JSON(200, gin.H{
			"assignment": assign,
			"questions":  questions,
		})
	})

	r.GET("/api/assignments/:id/qrcode", func(c *gin.Context) {
		id := c.Param("id")
		url := fmt.Sprintf("http://localhost:8080/assignments/do?id=%s", id)

		png, err := qrcode.Encode(url, qrcode.Medium, 256)
		if err != nil {
			c.JSON(500, gin.H{"error": "生成二维码失败"})
			return
		}

		c.Data(http.StatusOK, "image/png", png)
	})

	// 答题页面（学生扫码进入）
	r.GET("/assignments/do", func(c *gin.Context) {
		assignID := c.Query("id")
		c.HTML(http.StatusOK, "do_assignment.html", gin.H{
			"AssignmentID": assignID,
		})
	})

	r.POST("/api/submissions", func(c *gin.Context) {
		var req struct {
			AssignmentID string            `json:"assignment_id"`
			StudentID    string            `json:"student_id"`
			StudentName  string            `json:"student_name"`
			Answers      map[string]string `json:"answers"`
			Code         string            `json:"code"`
		}
		if err := c.BindJSON(&req); err != nil {
			c.JSON(400, gin.H{"error": "参数错误"})
			return
		}

		id, err := assignSvc.SubmitAssignment(req.AssignmentID, req.StudentID, req.StudentName, req.Answers, req.Code)
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}

		go func() {
			ctx := context.Background()
			assignSvc.GradeSubmission(ctx, id)
		}()

		c.JSON(200, gin.H{
			"submission_id": id,
			"message":       "提交成功，AI正在批改...",
		})
	})

	r.GET("/api/submissions/:id", func(c *gin.Context) {
		id := c.Param("id")
		sub, err := assignSvc.GetSubmission(id)
		if err != nil {
			c.JSON(404, gin.H{"error": "提交记录不存在"})
			return
		}
		c.JSON(200, sub)
	})

	// 反馈 API
	r.POST("/api/feedback", func(c *gin.Context) {
		var req struct {
			Title       string `json:"title"`
			Content     string `json:"content"`
			Type        string `json:"type"`
			AnonymousID string `json:"anonymous_id"`
		}
		if err := c.BindJSON(&req); err != nil {
			c.JSON(400, gin.H{"error": "参数错误"})
			return
		}

		if err := feedbackSvc.CreateFeedback(req.Title, req.Content, req.Type, req.AnonymousID); err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, gin.H{"message": "反馈发布成功"})
	})

	r.GET("/api/feedback", func(c *gin.Context) {
		feedbacks, err := feedbackSvc.GetFeedbackList()
		if err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, feedbacks)
	})

	r.POST("/api/feedback/:id/like", func(c *gin.Context) {
		id, _ := strconv.Atoi(c.Param("id"))
		if err := feedbackSvc.LikeFeedback(uint(id)); err != nil {
			c.JSON(500, gin.H{"error": err.Error()})
			return
		}
		c.JSON(200, gin.H{"message": "点赞成功"})
	})

	r.Run(":8080")
}
