<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ä½œä¸šç­”é¢˜ - GoCodeMentor</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }
        .deadline-info { 
            background: #fff3cd; 
            border-left: 4px solid #ffc107; 
            padding: 12px 15px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .deadline-info.warning { 
            background: #f8d7da; 
            border-left-color: #dc3545; 
        }
        .deadline-info.success { 
            background: #d4edda; 
            border-left-color: #28a745; 
        }
        .deadline-icon { font-size: 18px; }
        .deadline-text { font-size: 14px; flex-grow: 1; }
        .question { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-top: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 14px; 
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 20px; 
        }
        button:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
        }
        .result { margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; display: none; }
        .error-message { 
            color: #dc3545; 
            background: #f8d7da; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            display: none; 
        }
        .time-remaining { 
            font-weight: bold; 
            color: #dc3545; 
            background: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            margin-left: 5px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä½œä¸šç­”é¢˜</h1>
        <div id="deadlineInfo" style="display: none;"></div>
        <div id="errorMessage" class="error-message"></div>
        <div id="assignmentContent">åŠ è½½ä¸­...</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const assignId = urlParams.get('id');
        let assignmentDeadline = null;
        let isExpired = false;
        
        async function loadAssignment() {
            try {
                const res = await fetch('/api/assignments/' + assignId);
                const data = await res.json();
                
                // æ£€æŸ¥ä½œä¸šæˆªæ­¢æ—¶é—´
                if (data.assignment && data.assignment.Deadline) {
                    assignmentDeadline = new Date(data.assignment.Deadline);
                    const now = new Date();
                    const timeRemaining = assignmentDeadline - now;
                    
                    // è®¡ç®—å‰©ä½™æ—¶é—´
                    const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let deadlineClass = 'deadline-info';
                    let deadlineMessage = '';
                    let icon = 'â°';
                    
                    if (timeRemaining <= 0) {
                        isExpired = true;
                        deadlineClass = 'deadline-info warning';
                        deadlineMessage = `âš ï¸ ä½œä¸šæäº¤å·²æˆªæ­¢ï¼ˆæˆªæ­¢æ—¶é—´ï¼š${assignmentDeadline.toLocaleString('zh-CN')}ï¼‰`;
                        icon = 'â›”';
                    } else if (timeRemaining < 24 * 60 * 60 * 1000) { // å°äº1å¤©
                        deadlineClass = 'deadline-info warning';
                        deadlineMessage = `âš ï¸ ä½œä¸šå³å°†æˆªæ­¢ï¼ˆæˆªæ­¢æ—¶é—´ï¼š${assignmentDeadline.toLocaleString('zh-CN')}ï¼‰`;
                        if (days === 0 && hours < 2) {
                            deadlineMessage += `ï¼Œå‰©ä½™æ—¶é—´ï¼š${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                            icon = 'ğŸš¨';
                        } else {
                            deadlineMessage += `ï¼Œå‰©ä½™${days}å¤©${hours}å°æ—¶`;
                            icon = 'âš ï¸';
                        }
                    } else {
                        deadlineClass = 'deadline-info success';
                        deadlineMessage = `âœ… ä½œä¸šå¯æäº¤ï¼ˆæˆªæ­¢æ—¶é—´ï¼š${assignmentDeadline.toLocaleString('zh-CN')}ï¼‰`;
                        deadlineMessage += `ï¼Œå‰©ä½™${days}å¤©${hours}å°æ—¶`;
                        icon = 'âœ…';
                    }
                    
                    document.getElementById('deadlineInfo').innerHTML = `
                        <div class="${deadlineClass}">
                            <span class="deadline-icon">${icon}</span>
                            <span class="deadline-text">${deadlineMessage}</span>
                        </div>
                    `;
                    document.getElementById('deadlineInfo').style.display = 'block';
                }
                
                let html = `<h2>${data.assignment.Title}</h2><p>${data.assignment.Description || 'æš‚æ— æè¿°'}</p>`;
                
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach((q, idx) => {
                        const questionId = q.ID || q.id;
                        html += `<div class="question">
                            <p><strong>é¢˜ç›® ${idx+1} (${q.Type})</strong></p>
                            <p>${q.Content}</p>
                            ${q.Type === 'code' ? 
                                `<textarea id="ans_${questionId}" rows="6" placeholder="åœ¨æ­¤è¾“å…¥ä»£ç ..." ${isExpired ? 'disabled' : ''}></textarea>` :
                                `<input type="text" id="ans_${questionId}" placeholder="ä½ çš„ç­”æ¡ˆ" ${isExpired ? 'disabled' : ''}>`
                            }
                        </div>`;
                    });
                } else {
                    html += `<textarea id="code_answer" rows="10" placeholder="ç¼–ç¨‹é¢˜ï¼šåœ¨æ­¤è¾“å…¥å®Œæ•´ä»£ç ..." ${isExpired ? 'disabled' : ''}></textarea>`;
                }
                
                // è·å–å­¦ç”Ÿä¿¡æ¯ï¼ˆä»localStorageæˆ–cookieï¼‰
                const userId = getCookie('user_id') || localStorage.getItem('user_id');
                const userName = getCookie('user_name') || localStorage.getItem('user_name');
                
                html += `
                    <div style="margin-top: 20px;">
                        <input type="text" id="studentName" placeholder="ä½ çš„å§“å" style="width: 200px; margin-right: 10px;" 
                               value="${userName || ''}" ${isExpired ? 'disabled' : ''}>
                        <button id="submitBtn" onclick="submit()" ${isExpired ? 'disabled' : ''}>
                            ${isExpired ? 'âŒ ä½œä¸šå·²æˆªæ­¢' : 'æäº¤ä½œä¸š'}
                        </button>
                    </div>
                    <div id="result" class="result"></div>
                `;
                
                document.getElementById('assignmentContent').innerHTML = html;
                
                // å¦‚æœå·²è¿‡æœŸï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (isExpired) {
                    document.getElementById('errorMessage').innerHTML = 
                        'âŒ æ­¤ä½œä¸šæäº¤å·²æˆªæ­¢ï¼Œæ— æ³•ç»§ç»­æäº¤ã€‚å¦‚æœ‰ç–‘é—®è¯·è”ç³»æ•™å¸ˆã€‚';
                    document.getElementById('errorMessage').style.display = 'block';
                }
                
            } catch (e) {
                document.getElementById('assignmentContent').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥ï¼š' + e.message + '</p>';
            }
        }
        
        // è·å–cookieè¾…åŠ©å‡½æ•°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }
        
        async function submit() {
            // å†æ¬¡æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆé˜²æ­¢ç”¨æˆ·åœ¨é¡µé¢åœç•™æ—¶é—´è¿‡é•¿ï¼‰
            if (isExpired) {
                alert('ä½œä¸šå·²æˆªæ­¢ï¼Œæ— æ³•æäº¤ï¼');
                return;
            }
            
            const studentName = document.getElementById('studentName').value;
            if (!studentName) { 
                alert('è¯·è¾“å…¥å§“å'); 
                return; 
            }
            
            const answers = {};
            document.querySelectorAll('[id^="ans_"]').forEach(el => {
                const questionId = el.id.replace('ans_', '');
                answers[questionId] = el.value;
            });
            
            const code = document.getElementById('code_answer')?.value || '';
            
            try {
                // è·å–å­¦ç”ŸID
                const studentId = getCookie('user_id') || localStorage.getItem('user_id') || 'stu_' + Date.now();
                
                const res = await fetch('/api/submissions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        assignment_id: assignId,
                        student_id: studentId,
                        student_name: studentName,
                        answers: answers,
                        code: code
                    })
                });
                
                const data = await res.json();
                if (data.error) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æˆªæ­¢æ—¶é—´ç›¸å…³çš„é”™è¯¯
                    if (data.error.includes('æˆªæ­¢') || data.error.includes('è¿‡æœŸ')) {
                        isExpired = true;
                        document.getElementById('submitBtn').disabled = true;
                        document.getElementById('submitBtn').textContent = 'âŒ ä½œä¸šå·²æˆªæ­¢';
                        document.getElementById('errorMessage').innerHTML = 
                            'âŒ ' + data.error + 'ï¼Œæ— æ³•æäº¤ã€‚';
                        document.getElementById('errorMessage').style.display = 'block';
                        alert(data.error);
                    } else {
                        alert('æäº¤å¤±è´¥ï¼š' + data.error);
                    }
                } else {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML = `
                        <h3>âœ… æäº¤æˆåŠŸï¼</h3>
                        <p>æäº¤IDï¼š${data.id || data.submission_id}</p>
                        <p>AIæ­£åœ¨æ‰¹æ”¹ä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢æˆç»©...</p>
                    `;
                    
                    // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
                    document.getElementById('submitBtn').disabled = true;
                    document.getElementById('submitBtn').textContent = 'âœ… å·²æäº¤';
                    
                    // ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¡†
                    document.querySelectorAll('[id^="ans_"], #code_answer, #studentName').forEach(el => {
                        el.disabled = true;
                    });
                }
            } catch (e) {
                alert('æäº¤å¤±è´¥ï¼š' + e.message);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.onload = loadAssignment;
        
        // å®šæœŸæ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
        if (assignId) {
            setInterval(() => {
                if (assignmentDeadline && !isExpired) {
                    const now = new Date();
                    if (now > assignmentDeadline) {
                        isExpired = true;
                        document.getElementById('submitBtn').disabled = true;
                        document.getElementById('submitBtn').textContent = 'âŒ ä½œä¸šå·²æˆªæ­¢';
                        document.getElementById('errorMessage').innerHTML = 
                            'âŒ ä½œä¸šæäº¤å·²æˆªæ­¢ï¼Œæ— æ³•ç»§ç»­æäº¤ã€‚';
                        document.getElementById('errorMessage').style.display = 'block';
                        
                        // ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¡†
                        document.querySelectorAll('[id^="ans_"], #code_answer, #studentName').forEach(el => {
                            el.disabled = true;
                        });
                    }
                }
            }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        }
    </script>
</body>
</html>