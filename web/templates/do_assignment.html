<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>作业答题 - GoCodeMentor</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .question { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 20px; }
        .result { margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>作业答题</h1>
        <div id="assignmentContent">加载中...</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const assignId = urlParams.get('id');
        
        async function loadAssignment() {
            try {
                const res = await fetch('/api/assignments/' + assignId);
                const data = await res.json();
                
                let html = `<h2>${data.assignment.Title}</h2><p>${data.assignment.Description}</p>`;
                
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach((q, idx) => {
                        html += `<div class="question">
                            <p><strong>题目 ${idx+1} (${q.Type})</strong></p>
                            <p>${q.Content}</p>
                            ${q.Type === 'code' ? 
                                `<textarea id="ans_${q.ID}" rows="6" placeholder="在此输入代码..."></textarea>` :
                                `<input type="text" id="ans_${q.ID}" placeholder="你的答案">`
                            }
                        </div>`;
                    });
                } else {
                    html += `<textarea id="code_answer" rows="10" placeholder="编程题：在此输入完整代码..."></textarea>`;
                }
                
                html += `
                    <div style="margin-top: 20px;">
                        <input type="text" id="studentName" placeholder="你的姓名" style="width: 200px; margin-right: 10px;">
                        <button onclick="submit()">提交作业</button>
                    </div>
                    <div id="result" class="result"></div>
                `;
                
                document.getElementById('assignmentContent').innerHTML = html;
            } catch (e) {
                document.getElementById('assignmentContent').innerHTML = '<p style="color: red;">加载失败</p>';
            }
        }
        
        async function submit() {
            const studentName = document.getElementById('studentName').value;
            if (!studentName) { alert('请输入姓名'); return; }
            
            const answers = {};
            document.querySelectorAll('[id^="ans_"]').forEach(el => {
                answers[el.id.replace('ans_', '')] = el.value;
            });
            
            const code = document.getElementById('code_answer')?.value || '';
            
            try {
                const res = await fetch('/api/submissions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        assignment_id: assignId,
                        student_id: 'stu_' + Date.now(),
                        student_name: studentName,
                        answers: answers,
                        code: code
                    })
                });
                const data = await res.json();
                if (data.error) {
                    alert('提交失败：' + data.error);
                } else {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML = `
                        <h3>✅ 提交成功！</h3>
                        <p>作业ID：${data.submission_id}</p>
                        <p>AI正在批改中，请稍后查询成绩...</p>
                    `;
                }
            } catch (e) {
                alert('提交失败');
            }
        }
        
        loadAssignment();
    </script>
</body>
</html>