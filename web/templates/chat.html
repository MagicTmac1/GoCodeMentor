{{template "layout" .}}

{{define "head"}}{{end}}

{{define "chat_content"}}
<div style="display: flex; height: 100%;">
    <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
    <div style="width: 260px; background: #f5f5f5; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        <!-- æ–°å»ºå¯¹è¯æŒ‰é’® -->
        <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
            <button onclick="newChat()" style="width: 100%; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                <span>+</span>
                <span>æ–°å»ºå¯¹è¯</span>
            </button>
        </div>
        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="sessionList" style="flex: 1; overflow-y: auto; padding: 10px;">
            <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">æš‚æ— å†å²å¯¹è¯</div>
        </div>
    </div>
    
    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <div style="flex: 1; display: flex; flex-direction: column;">
        <!-- é¡¶éƒ¨å½“å‰ä¼šè¯ä¿¡æ¯ -->
        <div style="padding: 12px 20px; background: white; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between;">
            <span style="font-size: 14px; color: #666;">
                å½“å‰ä¼šè¯: <span id="chatSession" style="font-weight: 500; color: #333;">æ–°ä¼šè¯</span>
            </span>
            <button onclick="deleteCurrentSession()" id="deleteBtn" style="display: none; padding: 6px 12px; font-size: 12px; background: #ff4d4f; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
        </div>
        
        <!-- èŠå¤©å†…å®¹åŒº -->
        <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 20px; background: #fafafa;">
            <div style="text-align: center; color: #999; font-size: 13px; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¤–</div>
                <p>AIåŠ©æ•™å·²å°±ç»ªï¼Œæ”¯æŒ Markdown æ ¼å¼</p>
                <p style="font-size: 12px; margin-top: 10px;">è¾“å…¥ Go è¯­è¨€é—®é¢˜å¼€å§‹å¯¹è¯</p>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒº -->
        <div style="padding: 15px 20px; background: white; border-top: 1px solid #e0e0e0;">
            <div style="display: flex; gap: 10px; max-width: 800px; margin: 0 auto;">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„ Go è¯­è¨€é—®é¢˜..." style="flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none;" onkeypress="if(event.keyCode===13) sendChat()">
                <button onclick="sendChat()" class="btn" style="padding: 10px 24px;">å‘é€</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "chat_scripts"}}
<script>
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

let chatSessionId = localStorage.getItem('chat_session_id') || '';
let sessions = JSON.parse(localStorage.getItem('chat_sessions') || '[]');

// åˆå§‹åŒ– - ä»æœåŠ¡å™¨åŠ è½½æ‰€æœ‰å†å²ä¼šè¯
(async function init() {
    await loadSessionsFromServer();
})();

// è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»Cookieæˆ–localStorageï¼‰
function getUserInfo() {
    const userId = localStorage.getItem('user_id') || '';
    const userRole = localStorage.getItem('user_role') || '';
    return { userId, userRole };
}

// ä»æœåŠ¡å™¨åŠ è½½ä¼šè¯åˆ—è¡¨
async function loadSessionsFromServer() {
    // å…ˆæ˜¾ç¤ºåŠ è½½ä¸­
    document.getElementById('sessionList').innerHTML = '<div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">åŠ è½½ä¸­...</div>';
    
    const { userId, userRole } = getUserInfo();
    
    try {
        const res = await fetch('/api/sessions', {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        if (res.ok) {
            const data = await res.json();
            if (data && data.length > 0) {
                // è½¬æ¢æœåŠ¡å™¨ä¼šè¯æ ¼å¼åˆ°æœ¬åœ°æ ¼å¼
                sessions = [];
                for (const s of data) {
                    const sessionId = s.ID || s.id;
                    // è·å–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
                    let title = 'æ–°å¯¹è¯';
                    try {
                        const msgRes = await fetch('/api/history?session_id=' + sessionId);
                        if (msgRes.ok) {
                            const messages = await msgRes.json();
                            const firstUserMsg = messages.find(m => m.Role === 'user' || m.role === 'user');
                            if (firstUserMsg) {
                                const content = firstUserMsg.Content || firstUserMsg.content;
                                title = content.slice(0, 20) + (content.length > 20 ? '...' : '');
                            }
                        }
                    } catch (e) {
                        console.log('è·å–ä¼šè¯æ¶ˆæ¯å¤±è´¥:', e);
                    }
                    
                    sessions.push({
                        id: sessionId,
                        title: title,
                        time: new Date(s.CreatedAt || s.created_at).getTime(),
                        messages: [] // å»¶è¿ŸåŠ è½½å®Œæ•´æ¶ˆæ¯
                    });
                }
                localStorage.setItem('chat_sessions', JSON.stringify(sessions));
            } else {
                sessions = [];
            }
        }
    } catch (e) {
        console.log('ä»æœåŠ¡å™¨åŠ è½½ä¼šè¯å¤±è´¥:', e);
        // å¤±è´¥æ—¶å°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤
        const cached = localStorage.getItem('chat_sessions');
        if (cached) {
            sessions = JSON.parse(cached);
        }
    }
    
    // æ¸²æŸ“åˆ—è¡¨
    loadSessionList();
    
    // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼Œè‡ªåŠ¨åŠ è½½è¯¥ä¼šè¯
    if (chatSessionId) {
        const session = sessions.find(s => s.id === chatSessionId);
        if (session) {
            await loadSessionFromServer(chatSessionId);
        }
    }
}

// åŠ è½½å¯¹è¯åˆ—è¡¨ï¼ˆæœ¬åœ°æ¸²æŸ“ï¼‰
function loadSessionList() {
    const listEl = document.getElementById('sessionList');
    if (sessions.length === 0) {
        listEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">æš‚æ— å†å²å¯¹è¯</div>';
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åº
    sessions.sort((a, b) => b.time - a.time);
    
    listEl.innerHTML = sessions.map(s => `
        <div onclick="switchSession('${s.id}')" 
             style="padding: 12px; margin-bottom: 8px; background: ${s.id === chatSessionId ? '#667eea' : 'white'}; 
                    color: ${s.id === chatSessionId ? 'white' : '#333'}; border-radius: 8px; cursor: pointer; 
                    font-size: 13px; transition: all 0.2s; border: 1px solid ${s.id === chatSessionId ? '#667eea' : '#eee'};"
             onmouseover="this.style.background='${s.id === chatSessionId ? '#5a6fd6' : '#f8f9fa'}'"
             onmouseout="this.style.background='${s.id === chatSessionId ? '#667eea' : 'white'}'">
            <div style="font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.title}</div>
            <div style="font-size: 11px; opacity: 0.7;">${new Date(s.time).toLocaleString()}</div>
        </div>
    `).join('');
}

// æ–°å»ºå¯¹è¯
function newChat() {
    chatSessionId = '';
    localStorage.removeItem('chat_session_id');
    document.getElementById('chatBox').innerHTML = `
        <div style="text-align: center; color: #999; font-size: 13px; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¤–</div>
            <p>AIåŠ©æ•™å·²å°±ç»ªï¼Œæ”¯æŒ Markdown æ ¼å¼</p>
            <p style="font-size: 12px; margin-top: 10px;">è¾“å…¥ Go è¯­è¨€é—®é¢˜å¼€å§‹å¯¹è¯</p>
        </div>
    `;
    document.getElementById('chatSession').textContent = 'æ–°ä¼šè¯';
    document.getElementById('deleteBtn').style.display = 'none';
    loadSessionList();
}

// åˆ‡æ¢å¯¹è¯
async function switchSession(id) {
    chatSessionId = id;
    localStorage.setItem('chat_session_id', id);
    await loadSessionFromServer(id);
    loadSessionList();
}

// ä»æœåŠ¡å™¨åŠ è½½æŒ‡å®šå¯¹è¯
async function loadSessionFromServer(id) {
    const session = sessions.find(s => s.id === id);
    if (!session) return;
    
    // æ›´æ–°UIæ˜¾ç¤ºå½“å‰ä¼šè¯
    chatSessionId = id;
    localStorage.setItem('chat_session_id', id);
    document.getElementById('chatSession').textContent = session.title;
    document.getElementById('deleteBtn').style.display = 'inline-block';
    
    // æ›´æ–°åˆ—è¡¨é€‰ä¸­çŠ¶æ€
    loadSessionList();
    
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">åŠ è½½ä¸­...</div>';
    
    try {
        // ä»æœåŠ¡å™¨è·å–æ¶ˆæ¯å†å²
        const res = await fetch('/api/history?session_id=' + id);
        if (res.ok) {
            const messages = await res.json();
            chatBox.innerHTML = '';
            
            if (messages && messages.length > 0) {
                // è½¬æ¢æœåŠ¡å™¨æ¶ˆæ¯æ ¼å¼å¹¶æ˜¾ç¤º
                session.messages = messages.map(m => ({
                    role: m.Role || m.role,
                    content: m.Content || m.content,
                    isHTML: (m.Role || m.role) === 'assistant'
                }));
                
                session.messages.forEach(msg => {
                    appendMessage(msg.role, msg.content, msg.isHTML, false);
                });
            } else {
                chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— æ¶ˆæ¯</div>';
            }
        } else {
            chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">åŠ è½½å¤±è´¥</div>';
        }
    } catch (e) {
        chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// å…¼å®¹æ—§æ–¹æ³•
function loadSession(id) {
    loadSessionFromServer(id);
}

// åˆ é™¤å½“å‰å¯¹è¯
function deleteCurrentSession() {
    if (!chatSessionId) return;
    if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å‰å¯¹è¯å—ï¼Ÿ')) return;
    
    sessions = sessions.filter(s => s.id !== chatSessionId);
    localStorage.setItem('chat_sessions', JSON.stringify(sessions));
    newChat();
}

// ä¿å­˜æ¶ˆæ¯åˆ°ä¼šè¯
function saveMessage(role, content, isHTML = false) {
    if (!chatSessionId) return;
    
    let session = sessions.find(s => s.id === chatSessionId);
    const isNewSession = !session;
    
    if (isNewSession) {
        // åˆ›å»ºæ–°ä¼šè¯ï¼Œä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
        const title = role === 'user' 
            ? content.slice(0, 20) + (content.length > 20 ? '...' : '')
            : 'æ–°å¯¹è¯';
        session = {
            id: chatSessionId,
            title: title,
            time: Date.now(),
            messages: []
        };
        sessions.push(session);
    }
    
    session.messages.push({ role, content, isHTML });
    session.time = Date.now();
    
    // æ›´æ–°æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
    if (isNewSession && role === 'assistant' && session.messages.find(m => m.role === 'user')) {
        const firstUserMsg = session.messages.find(m => m.role === 'user');
        session.title = firstUserMsg.content.slice(0, 20) + (firstUserMsg.content.length > 20 ? '...' : '');
    }
    
    localStorage.setItem('chat_sessions', JSON.stringify(sessions));
    loadSessionList();
}

function appendMessage(role, content, isHTML = false, save = true) {
    const box = document.getElementById('chatBox');
    const div = document.createElement('div');
    div.style.margin = '15px 0';
    div.style.padding = '12px 16px';
    div.style.borderRadius = '12px';
    div.style.maxWidth = '80%';
    div.style.lineHeight = '1.6';
    
    if (role === 'user') {
        div.style.background = '#667eea';
        div.style.color = 'white';
        div.style.marginLeft = 'auto';
        div.textContent = content;
    } else {
        div.style.background = 'white';
        div.style.border = '1px solid #e0e0e0';
        div.style.marginRight = 'auto';
        div.className = 'markdown-body';
        if (isHTML) {
            div.innerHTML = marked.parse(content);
            div.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        } else {
            div.textContent = content;
        }
    }
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    if (save) {
        saveMessage(role, content, isHTML);
    }
}

async function sendChat() {
    const input = document.getElementById('chatInput');
    const q = input.value.trim();
    if (!q) return;
    
    // å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œç”ŸæˆID
    if (!chatSessionId) {
        chatSessionId = 'session_' + Date.now();
        localStorage.setItem('chat_session_id', chatSessionId);
        document.getElementById('deleteBtn').style.display = 'inline-block';
    }
    
    appendMessage('user', q);
    input.value = '';
    
    const { userId, userRole } = getUserInfo();
    
    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': userId,
                'X-User-Role': userRole
            },
            body: JSON.stringify({session_id: chatSessionId, question: q})
        });
        const data = await res.json();
        if (data.error) {
            appendMessage('bot', 'é”™è¯¯ï¼š' + data.error);
        } else {
            appendMessage('bot', data.answer, true);
            // å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œæ›´æ–°IDå¹¶åˆ·æ–°åˆ—è¡¨
            if (data.session_id !== chatSessionId) {
                chatSessionId = data.session_id;
                localStorage.setItem('chat_session_id', chatSessionId);
                // æ›´æ–°å½“å‰ä¼šè¯çš„IDï¼ˆå› ä¸ºæœåŠ¡å™¨å¯èƒ½è¿”å›äº†æ–°çš„ï¼‰
                const session = sessions[sessions.length - 1];
                if (session) {
                    session.id = chatSessionId;
                    localStorage.setItem('chat_sessions', JSON.stringify(sessions));
                }
            }
            document.getElementById('chatSession').textContent = sessions.find(s => s.id === chatSessionId)?.title || 'æ–°ä¼šè¯';
            loadSessionList();
        }
    } catch (e) {
        appendMessage('bot', 'ç½‘ç»œé”™è¯¯ï¼š' + e.message);
    }
}
</script>
{{end}}
