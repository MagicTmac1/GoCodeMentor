{{template "layout" .}}

{{define "head"}}{{end}}

{{define "assignment_content"}}
<!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
<div style="text-align: center; margin-bottom: 30px; padding: 20px 0;">
    <h2 style="font-size: 28px; color: #333; margin-bottom: 20px; font-weight: 600;">ğŸ“ ä½œä¸šç®¡ç†</h2>
    <div style="display: flex; justify-content: center; gap: 15px;">
        <button onclick="showAIGenerate()" class="btn" style="padding: 12px 24px; font-size: 14px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
            âœ¨ AIç”Ÿæˆä½œä¸š
        </button>
        <button onclick="showCreateForm()" class="btn btn-secondary" style="padding: 12px 24px; font-size: 14px;">
            + æ‰‹åŠ¨åˆ›å»º
        </button>
    </div>
</div>

<!-- AIç”Ÿæˆè¡¨å• -->
<div id="aiGenerateForm" style="display: none; background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
    <h3>AIæ™ºèƒ½å‡ºé¢˜</h3>
    <div style="margin-bottom: 15px;">
        <label>çŸ¥è¯†ç‚¹</label>
        <input type="text" id="aiTopic" placeholder="ä¾‹å¦‚ï¼šGoroutineå¹¶å‘ç¼–ç¨‹" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
        <label>éš¾åº¦</label>
        <select id="aiDifficulty" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="easy">åˆçº§</option>
            <option value="medium" selected>ä¸­çº§</option>
            <option value="hard">é«˜çº§</option>
        </select>
    </div>
    <button onclick="generateByAI()" class="btn">å¼€å§‹ç”Ÿæˆ</button>
    <button onclick="hideAIGenerate()" class="btn btn-secondary">å–æ¶ˆ</button>
</div>

<!-- ä½œä¸šåˆ—è¡¨ -->
<div id="assignmentList" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
    <p style="color: #999; text-align: center;">åŠ è½½ä¸­...</p>
</div>

<!-- äºŒç»´ç å¼¹çª— -->
<div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 20px; text-align: center;">
        <h3>æ‰«ç ç­”é¢˜</h3>
        <img id="qrImg" src="" alt="äºŒç»´ç " style="margin: 20px 0; max-width: 256px;">
        <p style="color: #666; font-size: 14px;">å¾®ä¿¡æ‰«ç æˆ–å¤åˆ¶é“¾æ¥ç»™å­¦ç”Ÿ</p>
        <button onclick="closeQR()" class="btn btn-secondary">å…³é—­</button>
    </div>
</div>

<!-- æŸ¥çœ‹ä½œä¸šå¼¹çª— -->
<div id="viewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h2 id="viewTitle">ä½œä¸šè¯¦æƒ…</h2>
        <div id="viewContent" style="margin: 20px 0;"></div>
        <div style="text-align: right;">
            <button onclick="closeView()" class="btn btn-secondary">å…³é—­</button>
        </div>
    </div>
</div>
{{end}}

{{define "assignment_scripts"}}
<script>
// è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
const userId = localStorage.getItem('user_id') || '';
const userRole = localStorage.getItem('user_role') || '';

function showCreateForm() {
    alert('æ‰‹åŠ¨åˆ›å»ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨AIç”Ÿæˆ');
}

function showAIGenerate() {
    document.getElementById('aiGenerateForm').style.display = 'block';
}
function hideAIGenerate() {
    document.getElementById('aiGenerateForm').style.display = 'none';
}

async function generateByAI() {
    const topic = document.getElementById('aiTopic').value;
    const difficulty = document.getElementById('aiDifficulty').value;
    if (!topic) { alert('è¯·è¾“å…¥çŸ¥è¯†ç‚¹'); return; }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
        const res = await fetch('/api/assignments/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': userId,
                'X-User-Role': userRole
            },
            body: JSON.stringify({topic, difficulty})
        });
        const data = await res.json();
        if (res.ok) {
            alert('ç”ŸæˆæˆåŠŸï¼');
            hideAIGenerate();
            loadAssignments();
        } else {
            alert('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (e) {
        alert('ç½‘ç»œé”™è¯¯: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'å¼€å§‹ç”Ÿæˆ';
    }
}

async function loadAssignments() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!userId) {
        document.getElementById('assignmentList').innerHTML = '<p style="color: red; text-align: center;">è¯·å…ˆç™»å½•</p>';
        setTimeout(() => window.location.href = '/login', 1500);
        return;
    }
    
    try {
        const res = await fetch('/api/assignments', {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            throw new Error('è¯·æ±‚å¤±è´¥: ' + res.status);
        }
        
        const data = await res.json();
        const container = document.getElementById('assignmentList');
        
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center;">æš‚æ— ä½œä¸š</p>';
            return;
        }
        
        container.innerHTML = data.map(a => `
            <div style="border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; background: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3>${a.Title}</h3>
                        <p style="color: #666; margin: 8px 0; font-size: 14px;">${a.Description}</p>
                        <span style="font-size: 12px; color: #999;">${new Date(a.CreatedAt).toLocaleDateString()}</span>
                    </div>
                    <div>
                        <button onclick="viewAssignment('${a.ID}')" class="btn" style="padding: 6px 12px; font-size: 12px; margin-right: 8px;">
                            æŸ¥çœ‹
                        </button>
                        <button onclick="showQRCode('${a.ID}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                            äºŒç»´ç 
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('assignmentList').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
    }
}

function showQRCode(id) {
    document.getElementById('qrImg').src = '/api/assignments/' + id + '/qrcode';
    document.getElementById('qrModal').style.display = 'flex';
}

function closeQR() {
    document.getElementById('qrModal').style.display = 'none';
}

async function viewAssignment(id) {
    try {
        const res = await fetch('/api/assignments/' + id);
        const data = await res.json();
        
        const assign = data.assignment || {};
        const questions = data.questions || [];
        
        document.getElementById('viewTitle').textContent = assign.Title || 'ä½œä¸šè¯¦æƒ…';
        
        let html = `
            <p><strong>æè¿°ï¼š</strong>${assign.Description || 'æ— '}</p>
            <p><strong>ç±»å‹ï¼š</strong>${assign.Type || 'æœªçŸ¥'}</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${assign.Status || 'æœªçŸ¥'}</p>
            <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${assign.CreatedAt ? new Date(assign.CreatedAt).toLocaleString() : 'æœªçŸ¥'}</p>
        `;
        
        if (questions.length > 0) {
            html += '<h3 style="margin-top: 20px;">é¢˜ç›®åˆ—è¡¨</h3>';
            questions.forEach((q, idx) => {
                html += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 10px 0; background: #f9f9f9;">
                        <p><strong>é¢˜ç›® ${idx + 1} (${q.type || q.Type}):</strong> ${q.content || q.Content}</p>
                        ${(q.options || q.Options) ? `<p style="color: #666;">é€‰é¡¹ï¼š${q.options || q.Options}</p>` : ''}
                        <p style="color: #28a745;">ç­”æ¡ˆï¼š${q.answer || q.Answer || 'æš‚æ— '}</p>
                        <p style="color: #999; font-size: 12px;">åˆ†å€¼ï¼š${q.score || q.Score}åˆ†</p>
                    </div>
                `;
            });
        }
        
        document.getElementById('viewContent').innerHTML = html;
        document.getElementById('viewModal').style.display = 'flex';
    } catch (e) {
        alert('åŠ è½½ä½œä¸šè¯¦æƒ…å¤±è´¥: ' + e.message);
    }
}

function closeView() {
    document.getElementById('viewModal').style.display = 'none';
}

// é¡µé¢åŠ è½½æ—¶è·å–åˆ—è¡¨
loadAssignments();
</script>
{{end}}
