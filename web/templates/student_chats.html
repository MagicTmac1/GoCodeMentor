{{template "layout" .}}

{{define "head"}}{{end}}

{{define "page_content"}}
<div style="display: flex; height: 100%;">
    <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
    <div style="width: 300px; background: #f5f5f5; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        <!-- è¿”å›æŒ‰é’® -->
        <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
            <a id="backLink" href="/teacher/classes" style="color: #667eea; text-decoration: none; font-size: 14px;">â† è¿”å›</a>
        </div>
        <!-- å­¦ç”Ÿä¿¡æ¯ -->
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: white;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; margin: 0 auto 10px;">
                <span id="studentAvatar">?</span>
            </div>
            <h3 id="studentName" style="text-align: center; font-size: 16px; color: #333;">åŠ è½½ä¸­...</h3>
            <p style="text-align: center; color: #999; font-size: 12px; margin-top: 5px;">å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
        </div>
        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="sessionList" style="flex: 1; overflow-y: auto; padding: 10px;">
            <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <div style="flex: 1; display: flex; flex-direction: column;">
        <!-- é¡¶éƒ¨å½“å‰ä¼šè¯ä¿¡æ¯ -->
        <div style="padding: 12px 20px; background: white; border-bottom: 1px solid #e0e0e0;">
            <span style="font-size: 14px; color: #666;">
                å½“å‰ä¼šè¯: <span id="chatSession" style="font-weight: 500; color: #333;">è¯·é€‰æ‹©å¯¹è¯</span>
            </span>
        </div>
        
        <!-- èŠå¤©å†…å®¹åŒº -->
        <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 20px; background: #fafafa;">
            <div style="text-align: center; color: #999; font-size: 13px; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ’¬</div>
                <p>ç‚¹å‡»å·¦ä¾§å¯¹è¯æŸ¥çœ‹å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ä¸”æ˜¯æ•™å¸ˆ
const userId = localStorage.getItem('user_id');
const userRole = localStorage.getItem('user_role');

if (!userId) {
    window.location.href = '/login';
} else if (userRole !== 'teacher') {
    alert('åªæœ‰æ•™å¸ˆå¯ä»¥è®¿é—®æ­¤é¡µé¢');
    window.location.href = '/';
}

// è·å–å­¦ç”ŸIDå’Œåç§°
const pathParts = window.location.pathname.split('/');
const studentId = pathParts[2];
const urlParams = new URLSearchParams(window.location.search);
const studentName = urlParams.get('name') || 'å­¦ç”Ÿ';

// è®¾ç½®å­¦ç”Ÿä¿¡æ¯
document.getElementById('studentName').textContent = studentName;
document.getElementById('studentAvatar').textContent = studentName.charAt(0);
document.title = studentName + 'çš„ç­”ç–‘è®°å½• - GoCodeMentor';

// åŠ è½½å­¦ç”Ÿçš„å¯¹è¯åˆ—è¡¨
async function loadStudentSessions() {
    try {
        const res = await fetch('/api/students/' + studentId + '/sessions', {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (res.status === 403) {
                document.getElementById('sessionList').innerHTML = `
                    <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">æ— æƒæŸ¥çœ‹è¯¥å­¦ç”Ÿ</div>
                `;
                return;
            }
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const sessions = await res.json();
        const listEl = document.getElementById('sessionList');
        
        if (sessions.length === 0) {
            listEl.innerHTML = `
                <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“</div>
                    è¯¥å­¦ç”Ÿæš‚æ— ç­”ç–‘è®°å½•
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = sessions.map(s => `
            <div onclick="loadSession('${s.ID}')" 
                 style="padding: 12px; margin-bottom: 8px; background: white; 
                        color: #333; border-radius: 8px; cursor: pointer; 
                        font-size: 13px; transition: all 0.2s; border: 1px solid #eee;"
                 onmouseover="this.style.background='#f8f9fa'"
                 onmouseout="this.style.background='white'">
                <div style="font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.Title || 'æœªå‘½åå¯¹è¯'}</div>
                <div style="font-size: 11px; color: #999;">${new Date(s.UpdatedAt || s.updated_at).toLocaleString()}</div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('sessionList').innerHTML = `
            <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">
                åŠ è½½å¤±è´¥: ${e.message}
            </div>
        `;
    }
}

// åŠ è½½æŒ‡å®šå¯¹è¯
async function loadSession(sessionId) {
    document.getElementById('chatSession').textContent = 'åŠ è½½ä¸­...';
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">åŠ è½½ä¸­...</div>';
    
    try {
        const res = await fetch('/api/history?session_id=' + sessionId, {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const messages = await res.json();
        chatBox.innerHTML = '';
        
        if (messages && messages.length > 0) {
            // æ‰¾åˆ°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
            const firstUserMsg = messages.find(m => (m.Role || m.role) === 'user');
            if (firstUserMsg) {
                const content = firstUserMsg.Content || firstUserMsg.content;
                document.getElementById('chatSession').textContent = content.slice(0, 30) + (content.length > 30 ? '...' : '');
            } else {
                document.getElementById('chatSession').textContent = 'å¯¹è¯è®°å½•';
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            messages.forEach(m => {
                if ((m.Role || m.role) === 'system') return; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                
                const div = document.createElement('div');
                div.style.margin = '15px 0';
                div.style.padding = '12px 16px';
                div.style.borderRadius = '12px';
                div.style.maxWidth = '80%';
                div.style.lineHeight = '1.6';
                
                const role = m.Role || m.role;
                const content = m.Content || m.content;
                
                if (role === 'user') {
                    div.style.background = '#667eea';
                    div.style.color = 'white';
                    div.style.marginLeft = 'auto';
                    div.textContent = content;
                } else {
                    div.style.background = 'white';
                    div.style.border = '1px solid #e0e0e0';
                    div.style.marginRight = 'auto';
                    div.className = 'markdown-body';
                    div.innerHTML = marked.parse(content);
                }
                chatBox.appendChild(div);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        } else {
            chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— æ¶ˆæ¯</div>';
            document.getElementById('chatSession').textContent = 'ç©ºå¯¹è¯';
        }
    } catch (e) {
        chatBox.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
loadStudentSessions();
</script>
{{end}}
