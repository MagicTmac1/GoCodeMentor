{{template "layout" .}}

{{define "head"}}
<style>
    .chat-container {
        display: flex;
        height: 100%;
    }
    
    .session-list {
        width: 300px;
        background: #f5f5f5;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
    }
    
    .session-list-header {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .session-list-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    
    .session-item {
        padding: 12px;
        margin-bottom: 8px;
        background: white;
        color: #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        border: 1px solid #eee;
    }
    
    .session-item:hover {
        background: #f8f9fa;
    }
    
    .session-item.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .session-item.active:hover {
        background: #5a6fd6;
    }
    
    .session-title {
        font-weight: 500;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .session-time {
        font-size: 11px;
        color: #999;
    }
    
    .session-item.active .session-time {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .student-info {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
        text-align: center;
    }
    
    .student-avatar {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        font-weight: bold;
        margin: 0 auto 10px;
    }
    
    .student-name {
        text-align: center;
        font-size: 16px;
        color: #333;
        margin-bottom: 5px;
    }
    
    .student-subtitle {
        text-align: center;
        color: #999;
        font-size: 12px;
        margin-top: 5px;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 12px 20px;
        background: white;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .chat-header-text {
        font-size: 14px;
        color: #666;
    }
    
    .chat-header-session {
        font-weight: 500;
        color: #333;
    }
    
    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
    }
    
    .chat-welcome {
        text-align: center;
        color: #999;
        font-size: 13px;
        padding: 40px;
    }
    
    .chat-welcome-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
    
    .chat-message {
        margin: 15px 0;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 80%;
        line-height: 1.6;
    }
    
    .chat-message-user {
        background: #667eea;
        color: white;
        margin-left: auto;
    }
    
    .chat-message-assistant {
        background: white;
        border: 1px solid #e0e0e0;
        margin-right: auto;
    }
    
    .back-button {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
    }
    
    .back-button:hover {
        text-decoration: underline;
    }
    
    .no-sessions {
        color: #999;
        text-align: center;
        padding: 20px;
        font-size: 13px;
    }
    
    .loading {
        color: #999;
        text-align: center;
        padding: 20px;
        font-size: 13px;
    }
</style>
{{end}}

{{define "page_content"}}
<div class="chat-container">
    <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
    <div class="session-list">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="session-list-header">
            <a id="backLink" href="/teacher/classes" class="back-button">â† è¿”å›</a>
        </div>
        
        <!-- å­¦ç”Ÿä¿¡æ¯ -->
        <div class="student-info">
            <div class="student-avatar">
                <span id="studentAvatar">?</span>
            </div>
            <h3 id="studentName" class="student-name">åŠ è½½ä¸­...</h3>
            <p class="student-subtitle">å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
        </div>
        
        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="sessionList" class="session-list-content">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <div class="chat-area">
        <!-- é¡¶éƒ¨å½“å‰ä¼šè¯ä¿¡æ¯ -->
        <div class="chat-header">
            <span class="chat-header-text">
                å½“å‰ä¼šè¯: <span id="chatSession" class="chat-header-session">è¯·é€‰æ‹©å¯¹è¯</span>
            </span>
        </div>
        
        <!-- èŠå¤©å†…å®¹åŒº -->
        <div id="chatBox" class="chat-box">
            <div class="chat-welcome">
                <div class="chat-welcome-icon">ğŸ’¬</div>
                <p>ç‚¹å‡»å·¦ä¾§å¯¹è¯æŸ¥çœ‹å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ä¸”æ˜¯æ•™å¸ˆ
const userId = localStorage.getItem('user_id');
const userRole = localStorage.getItem('user_role');

if (!userId) {
    window.location.href = '/login';
} else if (userRole !== 'teacher') {
    alert('åªæœ‰æ•™å¸ˆå¯ä»¥è®¿é—®æ­¤é¡µé¢');
    window.location.href = '/';
}

// è·å–å­¦ç”ŸIDå’Œåç§°
const pathParts = window.location.pathname.split('/');
const studentId = pathParts[2];
const urlParams = new URLSearchParams(window.location.search);
const studentName = urlParams.get('name') || 'å­¦ç”Ÿ';

// è®¾ç½®å­¦ç”Ÿä¿¡æ¯
document.getElementById('studentName').textContent = studentName;
document.getElementById('studentAvatar').textContent = studentName.charAt(0);
document.title = studentName + 'çš„ç­”ç–‘è®°å½• - GoCodeMentor';

// åŠ è½½å­¦ç”Ÿçš„å¯¹è¯åˆ—è¡¨
async function loadStudentSessions() {
    try {
        const res = await fetch('/api/students/' + studentId + '/sessions', {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (res.status === 403) {
                document.getElementById('sessionList').innerHTML = `
                    <div class="no-sessions">æ— æƒæŸ¥çœ‹è¯¥å­¦ç”Ÿ</div>
                `;
                return;
            }
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const sessions = await res.json();
        const listEl = document.getElementById('sessionList');
        
        if (sessions.length === 0) {
            listEl.innerHTML = `
                <div class="no-sessions">
                    <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“</div>
                    è¯¥å­¦ç”Ÿæš‚æ— ç­”ç–‘è®°å½•
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = sessions.map(s => `
            <div onclick="loadSession('${s.ID}')" 
                 class="session-item"
                 data-session-id="${s.ID}">
                <div class="session-title">${s.Title || 'æœªå‘½åå¯¹è¯'}</div>
                <div class="session-time">${new Date(s.UpdatedAt || s.updated_at).toLocaleString()}</div>
            </div>
        `).join('');
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶åé«˜äº®å¤„ç†
        document.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    } catch (e) {
        document.getElementById('sessionList').innerHTML = `
            <div class="no-sessions">åŠ è½½å¤±è´¥: ${e.message}</div>
        `;
    }
}

// åŠ è½½æŒ‡å®šå¯¹è¯
async function loadSession(sessionId) {
    document.getElementById('chatSession').textContent = 'åŠ è½½ä¸­...';
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    try {
        const res = await fetch('/api/history?session_id=' + sessionId, {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const messages = await res.json();
        chatBox.innerHTML = '';
        
        if (messages && messages.length > 0) {
            // æ‰¾åˆ°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
            const firstUserMsg = messages.find(m => (m.Role || m.role) === 'user');
            if (firstUserMsg) {
                const content = firstUserMsg.Content || firstUserMsg.content;
                document.getElementById('chatSession').textContent = content.slice(0, 30) + (content.length > 30 ? '...' : '');
            } else {
                document.getElementById('chatSession').textContent = 'å¯¹è¯è®°å½•';
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            messages.forEach(m => {
                if ((m.Role || m.role) === 'system') return; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                
                const div = document.createElement('div');
                div.className = 'chat-message';
                
                const role = m.Role || m.role;
                const content = m.Content || m.content;
                
                if (role === 'user') {
                    div.classList.add('chat-message-user');
                    div.textContent = content;
                } else {
                    div.classList.add('chat-message-assistant');
                    div.className = 'chat-message chat-message-assistant markdown-body';
                    div.innerHTML = marked.parse(content);
                }
                chatBox.appendChild(div);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        } else {
            chatBox.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">ğŸ“­</div><p>æš‚æ— æ¶ˆæ¯</p></div>';
            document.getElementById('chatSession').textContent = 'ç©ºå¯¹è¯';
        }
    } catch (e) {
        chatBox.innerHTML = '<div class="no-sessions">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
loadStudentSessions();

// åˆå§‹åŒ– marked.js
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});
</script>
{{end}}