{{template "layout" .}}

{{define "head"}}
<style>
    :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --bg-light: #f9fafb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
    }

    .chat-container {
        display: flex;
        height: calc(100vh - 120px);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        margin: 20px 0;
    }
    
    .session-list {
        width: 320px;
        background: var(--bg-light);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    
    .session-list-header {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        background: white;
    }
    
    .session-list-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }
    
    .session-item {
        padding: 12px 16px;
        margin-bottom: 8px;
        background: white;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--border-color);
    }
    
    .session-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-color: var(--primary-color);
    }
    
    .session-item.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .session-title {
        font-weight: 600;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 14px;
    }
    
    .session-time {
        font-size: 11px;
        color: var(--text-muted);
    }
    
    .session-item.active .session-time {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .student-info {
        padding: 24px 16px;
        border-bottom: 1px solid var(--border-color);
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .student-avatar {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .student-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }
    
    .student-subtitle {
        color: var(--text-muted);
        font-size: 13px;
        margin: 4px 0 0;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }
    
    .chat-header {
        padding: 16px 24px;
        background: white;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-header-text {
        font-size: 14px;
        color: var(--text-muted);
    }
    
    .chat-header-session {
        font-weight: 600;
        color: var(--text-main);
        margin-left: 8px;
    }
    
    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .chat-welcome {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-align: center;
    }
    
    .chat-welcome-icon {
        font-size: 64px;
        margin-bottom: 16px;
        filter: grayscale(0.5);
        opacity: 0.5;
    }
    
    .chat-message {
        padding: 14px 18px;
        border-radius: 16px;
        max-width: 85%;
        line-height: 1.6;
        font-size: 15px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .chat-message-user {
        background: var(--primary-color);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    
    .chat-message-assistant {
        background: white;
        border: 1px solid var(--border-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
        color: var(--text-main);
    }
    
    .back-button {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: white;
    }
    
    .back-button:hover {
        color: var(--primary-color);
        border-color: var(--primary-color);
        background: rgba(79, 70, 229, 0.05);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .no-sessions {
        color: var(--text-muted);
        text-align: center;
        padding: 40px 20px;
    }
    
    .loading {
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
    }

    /* Markdown æ ·å¼å¾®è°ƒ */
    .markdown-body pre {
        background-color: #f1f5f9 !important;
        border-radius: 8px !important;
        padding: 12px !important;
    }

    .markdown-body code {
        font-family: 'Fira Code', monospace;
    }
</style>
{{end}}

{{define "page_content"}}
<div class="chat-container">
    <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
    <div class="session-list">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="session-list-header">
            <a onclick="goBack()" class="back-button">è¿”å›å­¦ç”Ÿåˆ—è¡¨</a>
        </div>
        
        <!-- å­¦ç”Ÿä¿¡æ¯ -->
        <div class="student-info">
            <div class="student-avatar">
                <span id="studentAvatar">?</span>
            </div>
            <h3 id="studentName" class="student-name">åŠ è½½ä¸­...</h3>
            <p class="student-subtitle">å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
        </div>
        
        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="sessionList" class="session-list-content">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <div class="chat-area">
        <!-- é¡¶éƒ¨å½“å‰ä¼šè¯ä¿¡æ¯ -->
        <div class="chat-header">
            <span class="chat-header-text">
                å½“å‰ä¼šè¯: <span id="chatSession" class="chat-header-session">è¯·é€‰æ‹©å¯¹è¯</span>
            </span>
        </div>
        
        <!-- èŠå¤©å†…å®¹åŒº -->
        <div id="chatBox" class="chat-box">
            <div class="chat-welcome">
                <div class="chat-welcome-icon">ğŸ’¬</div>
                <p>ç‚¹å‡»å·¦ä¾§å¯¹è¯æŸ¥çœ‹å­¦ç”Ÿçš„ç­”ç–‘è®°å½•</p>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ä¸”æ˜¯æ•™å¸ˆ
const userId = localStorage.getItem('user_id');
const userRole = localStorage.getItem('user_role');

if (!userId) {
    window.location.href = '/login';
} else if (userRole !== 'teacher') {
    alert('åªæœ‰æ•™å¸ˆå¯ä»¥è®¿é—®æ­¤é¡µé¢');
    window.location.href = '/';
}

// è·å–å­¦ç”ŸIDå’Œåç§°
const pathParts = window.location.pathname.split('/');
const studentId = pathParts[2];
const urlParams = new URLSearchParams(window.location.search);
const studentName = urlParams.get('name') || 'å­¦ç”Ÿ';

// è®¾ç½®å­¦ç”Ÿä¿¡æ¯
document.getElementById('studentName').textContent = studentName;
document.getElementById('studentAvatar').textContent = studentName.charAt(0);
document.title = studentName + 'çš„ç­”ç–‘è®°å½• - GoCodeMentor';

// è¿”å›ä¸Šä¸€çº§
function goBack() {
    // å°è¯•è¿”å›ä¸Šä¸€é¡µï¼Œå¦‚æœæ¥æºä¸æ˜¯å½“å‰ç³»ç»Ÿï¼Œåˆ™è·³è½¬åˆ°ç­çº§ç®¡ç†
    if (document.referrer && document.referrer.includes(window.location.host)) {
        window.history.back();
    } else {
        window.location.href = '/teacher/classes';
    }
}

// åŠ è½½å­¦ç”Ÿçš„å¯¹è¯åˆ—è¡¨
async function loadStudentSessions() {
    try {
        const res = await fetch('/api/students/' + studentId + '/sessions', {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (res.status === 403) {
                document.getElementById('sessionList').innerHTML = `
                    <div class="no-sessions">æ— æƒæŸ¥çœ‹è¯¥å­¦ç”Ÿ</div>
                `;
                return;
            }
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const sessions = await res.json();
        const listEl = document.getElementById('sessionList');
        
        if (sessions.length === 0) {
            listEl.innerHTML = `
                <div class="no-sessions">
                    <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“</div>
                    è¯¥å­¦ç”Ÿæš‚æ— ç­”ç–‘è®°å½•
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = sessions.map(s => `
            <div onclick="loadSession('${s.ID}')" 
                 class="session-item"
                 data-session-id="${s.ID}">
                <div class="session-title">${s.Title || 'æœªå‘½åå¯¹è¯'}</div>
                <div class="session-time">${new Date(s.UpdatedAt || s.updated_at).toLocaleString()}</div>
            </div>
        `).join('');
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶åé«˜äº®å¤„ç†
        document.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    } catch (e) {
        document.getElementById('sessionList').innerHTML = `
            <div class="no-sessions">åŠ è½½å¤±è´¥: ${e.message}</div>
        `;
    }
}

// åŠ è½½æŒ‡å®šå¯¹è¯
async function loadSession(sessionId) {
    document.getElementById('chatSession').textContent = 'åŠ è½½ä¸­...';
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    try {
        const res = await fetch('/api/history?session_id=' + sessionId, {
            headers: {
                'X-User-ID': userId,
                'X-User-Role': userRole
            }
        });
        
        if (!res.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
        }
        
        const messages = await res.json();
        chatBox.innerHTML = '';
        
        if (messages && messages.length > 0) {
            // æ‰¾åˆ°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
            const firstUserMsg = messages.find(m => (m.Role || m.role) === 'user');
            if (firstUserMsg) {
                const content = firstUserMsg.Content || firstUserMsg.content;
                document.getElementById('chatSession').textContent = content.slice(0, 30) + (content.length > 30 ? '...' : '');
            } else {
                document.getElementById('chatSession').textContent = 'å¯¹è¯è®°å½•';
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            messages.forEach(m => {
                if ((m.Role || m.role) === 'system') return; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                
                const div = document.createElement('div');
                div.className = 'chat-message';
                
                const role = m.Role || m.role;
                const content = m.Content || m.content;
                
                if (role === 'user') {
                    div.classList.add('chat-message-user');
                    div.textContent = content;
                } else {
                    div.classList.add('chat-message-assistant');
                    div.className = 'chat-message chat-message-assistant markdown-body';
                    div.innerHTML = marked.parse(content);
                }
                chatBox.appendChild(div);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        } else {
            chatBox.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">ğŸ“­</div><p>æš‚æ— æ¶ˆæ¯</p></div>';
            document.getElementById('chatSession').textContent = 'ç©ºå¯¹è¯';
        }
    } catch (e) {
        chatBox.innerHTML = '<div class="no-sessions">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
loadStudentSessions();

// åˆå§‹åŒ– marked.js
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});
</script>
{{end}}